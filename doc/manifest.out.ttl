@prefix dcterms: <http://purl.org/dc/terms/> .
@prefix pav: <http://purl.org/pav/> .
@prefix dcat: <http://www.w3.org/ns/dcat#> .
@prefix rdr: <http://www.re3data.org/schema/3-0> .
@prefix prov: <https://www.w3.org/TR/prov-o/> .
@prefix rdfs: <https://www.w3.org/2000/01/rdf-schema#> .

@prefix saved: <https://marine.gov.scot/metadata/saved/schema/> .
@prefix job: <https://marine.gov.scot/metadata/saved/schema/job_> .
@prefix service: <https://marine.gov.scot/metadata/saved/rap/> .
@prefix stage: <https://marine.gov.scot/metadata/saved/rap/stage_> .

@prefix : <https://marine.gov.scot/metadata/saved/rap_service_v0.3/66f1b101-7c04-4413-9258-48ae938cf260/> .
@prefix manpre: <https://marine.gov.scot/metadata/saved/rap_service_v0.3/66f1b101-7c04-4413-9258-48ae938cf260/manifest_pre#> .
@prefix jobinst: <https://marine.gov.scot/metadata/saved/rap_service_v0.3/66f1b101-7c04-4413-9258-48ae938cf260/job_> .
@prefix result: <https://marine.gov.scot/metadata/saved/rap_service_v0.3/66f1b101-7c04-4413-9258-48ae938cf260/result_> .

:RootManifestResults a saved:ResultsManifest ;
    rdfs:label "results_manifest" ;
    dcterms:title "Results manifest description for example RootManifest"@en ;
    dcterms:description: "This is an example results description, post processing by the SAVED RAP service/job runner" ;
    dcterms:publisher <https://marine.gov.scot> ;

    pav:createdOn "20240714T105900Z" ;
    pav:version "1" ;
    pav:createdAt <:manifest_results_v1.ttl> ;
    pav:createdWith service:application ;
    pav:derivedFrom manpre:RootManifest ;

    dcat:downloadURL <:RootManifestResults.ttl> ;
    dcat:mediaType "text/csv" ;
    
    # These really belong to the notion of a data catalogue
    rdr:language "eng" ;
    rdr:repositoryName "RAP service for SAVED" ;
    rdr:type "multidisciplinary" ;
    rdr:subjectName "sustainable aquaculture" ;
    rdr:software: "saved_rap" ;
    rdr:api: "0.3" ;
    rdr:apiUrl service:sparqlSink ;
    rdr:apiDocumentation service:sparqlDoc ;
    rdr:versioning "yes" ;
    rdr:dataAccessType "open" ;
    rdr:dataUploadType "restricted" ;
    rdr:remarks "For now, all data are considered open-access, with appropriate license" ;
    rdr:missionStatementUrl <https://marine.gov.scot/metadata/saved/> .
    
    saved:tables :sampling, :time_density_simple ;
    saved:jobs jobinst:example_time_density_simple ;
    saved:stages stage:monitor_gcp, stage:fetch_gcp, stage:job_producer, stage:job_runner, stage:bakery_prep, stage:bakery_comp;
    saved:results result:example_time_density_simple .

# Defining these here so I can think about these in the same context as
# this post-processing manifest
# I think that these should actually be generated by fisdat/fisup, and
# ideally shouldn't be repeated. However, these may have to be declared
# here, given we may be substituting the canonical URIs where they
# referred to local files before
<service:density.csv> a dcat:DataSet ;
    pav:createdWith <https://www.r-project.org/> ;
    pav:createdOn "19700101T000000Z" ;
    dcat:title "Example time/density file" ;
    dcat:description "This input file is derived from the time/density example, in turn derived from the sentinel cages sampling example set" ;
    dcat:license <https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/> ;
    dcat:downloadURL <:density.csv> ;
    dcat:mediaType "text/csv" ;
    dcat:format "text/csv" .

<service:cagedata-10.csv> a dcat:DataSet ;
    pav:createdWith <https://www.r-project.org/> ;
    pav:createdOn "19700101T000000Z" ;
    dcat:title "Example cage data file" ;
    dcat:description "This input file is derived from the time/density example, in turn derived from the sentinel cages sampling example set" ;
    dcat:license <https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/> ;
    dcat:downloadURL <:cagedata-10.csv> ;
    dcat:mediaType "text/csv" ;
    dcat:format "text/csv" .

jobinst:example_time_density_simple a saved:JobDesc ;
    # pav:derivedFrom pre:job_example_time_density_simple ;
    pav:createdWith service:fisdat, service:fisup ;
    dcterms:title "Example job time_density_simple" ;
    job:scope_collected [ a saved:ScopeDesc ;
            saved:column "TOTAL" ;
            saved:table <service:cagedata-10.csv> ;
            saved:variable saved:lice_af_total ] ;
    job:scope_modelled [ a saved:ScopeDesc ;
            saved:column "time" ;
            saved:table <service:density.csv> ;
            saved:variable saved:time ],
        [ a saved:ScopeDesc ;
            saved:column "density" ;
            saved:table <service:density.csv> ;
            saved:variable saved:density ] ;
    job:type "density" .
    
result:example_time_density_simple a saved:ResultDesc ;
    rdfs:label "result_time_density_simple" ;
    pav:createdAt <:result_example_time_density_simple.json> ;
    pav:createdWith service:application, stage:job_runner ;
    
    dcat:downloadURL <:result_example_time_density_simple.json> ;
    dcat:mediaType "text/json" ;
    dcat:format "text/json" .


# The RAP stages have three elements to them which effectively map to the PROV-O ontology:

# 1. A given job event which is to be processed: prov:Entity
# 2. The processing proper of the job event:     prov:Activity
# 3. The stage which processes the job event:    prov:Agent

# Rough idea:
# 
# First, the BEAM runs our OTP application, which is based on gen_stage.
# The stages themselves are processes like gen_server which are started,
# and respond to messages, with gen_stage handling backpressure for us.
# So, the stages are themselves an Entity. I guess the relevant Activity
# which we want to express here is when the stages were started.
# The RAP program itself is probably also an Entity, as well.
#
# Second, the stages themselves do some kind of processing, on a given
# job event. This post-processing manifest concerns itself with *one* job
# event per job description.
#
# Finally, there is a link between the different activities and the
# different stages, in terms of stages subscribing to each other. There
# may be other relations which we should record, namely there are certain
# stages which occur in parallel, but can be exchanged for each other.
# For instance, monitoring local storage occurs at the same time as
# monitoring e.g. GCP or some local object store, so we might use
# something like prov:alternateOf. The aspect of this which we're
# primarily recording is which stages are associated with a given job
# event, and this may be the way to do it.
# 
# So, let's say there's two jobs declared per manifest submitted.
# At minimum, we record the invocation of stages. For now, assume that
# the jobs are going through  more or less the same stages, i.e. the
# stages aren't being started dynamically, because starting stages
# dynamically would probably involve ConsumerSupervisor and recording the
# link between this and the other stages may be non-trivial.
# (I was mostly interested in doing this for the very last stage with
# ConsumerSupervisor, to re-generate HTML documentation efficiently.
# Then, there would be an Activity recorded for each job invoked.)


stage:monitor_gcp a saved:RAPStageInvocation ;
    rdr:software "saved_rap" ;
    saved:mix_profile "dev" ;
    saved:beam_application "Elixir.RAP" ;
    saved:beam_node "nonode" ;
    saved:beam_host "nohost" ;
    saved:beam_module "Elixir.RAP.Storage.Monitor" ;
    saved:gen_stage_type "producer" ;
    saved:gen_stage_subscriptions "nil" ;
    saved:gen_stage_dispatcher "Elixir.BroadcastDispatcher" ;
    pav:version "0.3" .
    
stage:fetch_gcp a saved:RAPStageInvocation ;
    rdr:software "saved_rap" ;
    saved:mix_profile "dev" ;
    saved:beam_application "Elixir.RAP" ;
    saved:beam_node "nonode" ;
    saved:beam_host "nohost" ;
    saved:beam_module "Elixir.RAP.Storage.GCP" ;
    saved:gen_stage_type "producer_consumer" ;
    saved:gen_stage_subscriptions "Elixir.RAP.Storage.Monitor" ;
    saved:gen_stage_dispatcher "Elixir.BroadcastDispatcher" ;
    pav:version "0.3" .

stage:job_producer a saved:RAPStageInvocation ;
    rdr:software "saved_rap" ;
    saved:mix_profile "dev" ;
    saved:beam_application "Elixir.RAP" ;
    saved:beam_node "nonode" ;
    saved:beam_host "nohost" ;
    saved:beam_module "Elixir.RAP.Job.Producer" ;
    saved:gen_stage_type "producer_consumer" ;
    saved:gen_stage_subscriptions "Elixir.RAP.Storage.GCP" ;
    saved:gen_stage_dispatcher "Elixir.BroadcastDispatcher" ;
    pav:version "0.3" .

stage:job_runner a saved:RAPStageInvocation ;
    rdr:software "saved_rap" ;
    saved:mix_profile "dev" ;
    saved:beam_application "Elixir.RAP" ;
    saved:beam_node "nonode" ;
    saved:beam_host "nohost" ;
    saved:beam_module "Elixir.RAP.Job.Runner" ;
    saved:gen_stage_type "producer_consumer" ;
    saved:gen_stage_subscriptions "Elixir.RAP.Job.Producer" ;
    saved:gen_stage_dispatcher "Elixir.BroadcastDispatcher" ;
    saved:invoked_job job:density ;
    pav:version "0.3" .
    
stage:bakery_prep a saved:RAPStageInvocation ;
    rdr:software "saved_rap" ;
    saved:mix_profile "dev" ;
    saved:beam_application "Elixir.RAP" ;
    saved:beam_node "nonode" ;
    saved:beam_host "nohost" ;
    saved:beam_module "Elixir.RAP.Bakery.Prepare" ;
    saved:gen_stage_type "producer_consumer" ;
    saved:gen_stage_subscriptions "Elixir.RAP.Job.Runner" ;
    saved:gen_stage_dispatcher "Elixir.BroadcastDispatcher" ;
    pav:version "0.3" .

stage:bakery_comp a saved:RAPStageInvocation ;
    rdr:software "saved_rap" ;
    saved:mix_profile "dev" ;
    saved:beam_application "Elixir.RAP" ;
    saved:beam_node "nonode" ;
    saved:beam_host "nohost" ;
    saved:beam_module "Elixir.RAP.Bakery.Compose" ;
    saved:gen_stage_type "consumer" ;
    saved:gen_stage_subscriptions "Elixir.RAP.Bakery.Prepare" ;
    saved:gen_stage_dispatcher "Elixir.BroadcastDispatcher" ;
    pav:version "0.3" .
